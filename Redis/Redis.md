## RDB持久化

- RDB（Redis database）

<img src="https://ldt-typora.oss-cn-shenzhen.aliyuncs.com/img/image-20220318211919331.png" alt="image-20220318211919331" style="zoom:50%;" />

- RDB文件用于保存和还原Redis服务器所有数据库中的所有键值对数据

- SAVE命令有服务器进程执行保存操作，所以该命令会阻塞服务器

- BGSAVE命令由子进程执行保存操作，所以该命令不会阻塞服务器

- 服务器状态中会保存所用用save选项设置的保存条件(saveparam字段)，当任意一个保存条件被满足时，服务器会自动执行BGSAVE命令。

  ```
  save 900 1
  save 300 10
  save 60 10000
  ```

  <img src="https://ldt-typora.oss-cn-shenzhen.aliyuncs.com/img/image-20220318213636088.png" alt="image-20220318213636088" style="zoom:50%;" />

- RDB文件是一个经过压缩的二进制文件，由多个部分组成。

- 对于不同类型的键值对，RDB文件会使用不同的方式来保存它们。



## AOF持久化

- Append Only File

![image-20220319094002297](https://ldt-typora.oss-cn-shenzhen.aliyuncs.com/img/image-20220319094002297.png)

### AOF持久化的实现

- AOF持久化功能的实现可以分为命令追加（append）、文件写入、文件同步（sync）三个步骤。

  - 命令追加

    当AOF持久化功能打开时，服务器在**执行完写命令**之后，会以协议格式将被执行的写命令追加到服务器状态的aof_buf缓存去的末尾

  - 文件写入与同步

    Redis服务器进程就是一个事件循环（Loop），这个循环中有文件事件和时间事件。

    <img src="https://ldt-typora.oss-cn-shenzhen.aliyuncs.com/img/image-20220319083536086.png" alt="image-20220319083536086" style="zoom:50%;" />

    | appendfsync选项的值 |                flushAppendOnlyFile函数的行为                 |
    | :-----------------: | :----------------------------------------------------------: |
    |       always        | 服务器在每个事件循环都要将aof_buf缓存区中的所有内容写入到AOF文件，并且同步AOF文件 |
    |  everysec（默认）   | 服务器在每个事件循环都要将aof_buf缓存区中的所有内容写入到AOF文件，并且每隔一秒就要在子线程中对AOF文件进行一次同步 |
    |         no          | 服务器在每个事件循环都要将aof_buf缓存区中的所有内容写入到AOF文件，至于何时同步AOF文件，则由操作系统决定 |



### AOF重写功能

- 为了解决AOF文件体积膨胀的问题，Redis提供了AOF文件重写（rewrite）功能。



#### AOF文件重写的实现

- 整体的实现过程：Redis将生成新的AOF文件替换旧AOF文件

  **注意：实际上，AOF文件重写并不需要对现有的AOF文件进行任何读取、分析后者写入操作，这个功能是通过读取服务器当前的数据库状态实现的。**

- **AOF文件重写的实现原理：首先从数据库中读取键现在的值，然后用一条命令去记录键值对，代替之前记录这个键值对的多条命令。**



#### AOF后台重写

1. 如何让服务器在执行AOF后台重写任务时还能正常接受请求：**Redis决定将AOF重写程序放在子程序里执行**

- 子进程进行AOF重写期间，服务器进程（父进程）可以继续处理命令请求。
- 子进程带有服务器进程的数据副本，使用子进程而不是线程，可以在避免使用锁的情况下，保证数据库的安全。



2. 如何解决数据库不一致（AOF后台执行时，Redis服务器数据库的状态可能发生改变）的问题：**Redis服务器设置了一个AOF重写缓冲区，这个缓冲区在服务器创建子进程之后开始使用，当Redis服务器执行完一个写命令之后，它会同时将这个写命令发送给AOF缓区和AOF重写缓冲区。**

- 在子进程执行AOF重写期间，服务器进程需要执行以下三个工作：
  - 执行客户端发来的命令
  - 将执行后的写命令追加到AOF缓冲区
  - 将执行后的写命令追加到AOF重写缓冲区

- 执行完AOF重写之后，父进程会调用一个信号处理函数，并执行以下工作：
  - 将AOF重写缓冲区中的所有内容写入到新AOF文件中，这时新AOF文件所保存的数据库状态将和服务器当前的数据库状态一致
  - 对新的AOF文件进行改名，原子地（atomic）覆盖现有的AOF文件，完成新旧两个AOF文件的替换。





