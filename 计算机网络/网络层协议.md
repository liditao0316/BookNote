## 网络层

> 网络层的重要知识点：
>
> - 虚拟互连的网络
> - IP地址与物理地址的关系
> - 传统分类的IP地址（包括子网掩码）和无分类域间路由选择CIDR
> - 路由选择协议的工作原理



### 网络层提供的两种服务

<img src="https://ldt-typora.oss-cn-shenzhen.aliyuncs.com/img/image-20220325151409165.png" alt="image-20220325151409165" style="zoom:50%;" />

>数据报服务是面向无连接的服务：
>
>- 网路层向上只提供简单灵活的、无连接的、**尽最大努力交付的数据报服务**。
>- **网络层不提供服务质量的承诺**。也就是说，所传送的分组可能**出错、丢失、重复和失序**，当然也不保证分组交付的时限。



### 网际协议IP

与IP协议配套使用的还有三个协议：

- 地址解析协议ARP（Address Resolution Protocol）
- 网际控制报文协议ICMP（Internet Control Message Protocol）
- 网际组管理协议IGMP（Internet Group Management Protocol）

<img src="https://ldt-typora.oss-cn-shenzhen.aliyuncs.com/img/image-20220325152056838.png" alt="image-20220325152056838" style="zoom:50%;margin-left:10px" />



### IP地址

#### IP地址的分类

IP地址从整体上看可以分为三大类：

- 单播地址（A、B、C类）
- 多播地址（D）
- 保留地址（E）

<img src="https://ldt-typora.oss-cn-shenzhen.aliyuncs.com/img/image-20220325152701761.png" alt="image-20220325152701761" style="zoom:50%;" />

> IP地址具有以下特点：
>
> - 每一个IP地址都由**网络号**和**主机号**两部分组成。
>   - IP地址管理机构在分配IP地址时只分配网络号（第一级），而剩下的主机号（第二级）则由得到该网络号的单位自行分配
>   - **路由器**仅根据目的主机所连接的**网络号**来转发分组，这样就可以使路由器的项目数大幅度减少，从而减少了路由表所占的存储空间以及查找路由表的时间
> - 实际上IP地址是标志一台主机（或路由器）和一条链路的**接口**。
> - 在IP地址中，所有分配到网络号的网络都是**平等**的。所谓平等，是指互联网同等对待每一个IP地址。

- 我们应当注意到：
  - 在同一个`局域网`上的主机或者路由器的IP地址中的`网络号`必须是一样的
  - 路由器总是具有两个或两个以上的IP地址
  - 当**两个路由器**直接相连时，在连接两端的**接口**处，可以分配也可以不分配IP地址



### 地址解析协议ARP

>ARP协议的用途是为了从网络层使用的IP地址，解析出在数据链路层使用的硬件地址

每一台主机都设有一个`ARP高速缓存`，里面有`本局域网`上的各主机和路由器IP地址到硬件地址的映射表，并且这个映射表会经常动态更新。

#### ARP协议的工作原理

假设现在主机A向主机B发送IP数据包：

1. 先在ARP cache中查找使用存在该IP与硬件地址的映射，如果有，就把这个硬件地址写入MAC帧，并发送出去；若没有，则按一下步骤找到主机B的硬件地址。
2. ARP进程在本局域网上**广播**发送一个ARP请求分组。
3. 在本局域网上的**所有主机上**运行的**ARP进程**都收到此ARP请求分组
4. 主机B的IP地址与ARP请求中的IP地址一致，就收下这个ARP分组，并发送**ARP响应分组**，同时在这个ARP响应分组中写入自己的硬件地址。
5. 主机A收到主机B的ARP响应分组后，就在其ARP高速缓存中写入主机B的IP地址到硬件地址的映射。

<img src="https://ldt-typora.oss-cn-shenzhen.aliyuncs.com/img/image-20220325161109555.png" alt="image-20220325161109555" style="zoom:50%;" />



### IP地址与硬件地址的关系

> 由于全世界存在着各式各样的网络，**他们使用不同的硬件地址**。要使这些**异构网络**能够互相通讯就必须进行**非常复杂的硬件地址转换工作**，因此由用户或用户主机来完成这项工作是不可能的事。但IP编址把这个复杂问题解决了。连接到互联网的主机只需各自拥有一个唯一的IP地址，他们之间的通信就像连接在同一个网络上那样简单方便，因为上述的调用ARP的复杂过程都是由计算机软件自动进行的，对用户来说是看不见这种调用过程。

#### 如何理解异构网络

在日常生活中，连接多个电脑通常会用到路由器或者交换机，他们两个之间有区别，比如交换机只能连接电脑，但是路由器可以连接电脑，也可以提供wifi给手机连接。那么由交换机组成的网络就属于同构网络，由路由器组成的网络就属于`异构网络`。因此，实现手机访问网络，那么路由器是要进行相应的`协议转换`的，比如将802.3/Ethernet II（局域网技术）变换成802.11协议头（无线局域网技术）。这样手机才能通过路由器访问外部网络。

#### 为什么不直接使用MAC地址通信

由于全世界存在着各式各样的网络，**他们使用不同的硬件地址**。要使这些**异构网络**能够互相通讯就必须进行**非常复杂的硬件地址转换工作**，因此由用户或用户主机来完成这项工作是不可能的事。

#### 为什么不直接使用IP地址通信

因为并非每个主机都一个公网IP，很多主机都是使用的内网IP，依据NAT对外访问；应用DHCP(动态主机配置协议），IP地址是动态变化的，比如说这个主机刚刚是这个IP，忽然断网了，被分配给另一个IP了，那么数据就会被传输给另外一个主机了。

>**MAC地址**类似一个人的身份证，通过身份证是无法正确地定位一个人的位置的，并找到那个人；**IP地址**类似一个房间的地址，因为房间可能住的人会经常变动，所以通过IP地址也是无法找到那个人的。只有**MAC地址和IP地址**同时使用才能正确地找到那个人。



### IP数据报格式

<img src="https://ldt-typora.oss-cn-shenzhen.aliyuncs.com/img/image-20220330174753596.png" alt="image-20220330174753596" style="zoom:50%;" />



### IP层转发分组的流程

每一条路由最主要的是以下两个信息：

（**目的网络地址**，**下一条地址**）