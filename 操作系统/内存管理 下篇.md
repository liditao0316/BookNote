#  内存管理 下篇

## 3.2 虚拟内存

### 3.2.1 虚拟内存的基本概念

#### 1、传统存储管理方式的特征、缺点

- 一次性：作业必须一次性全部装入内存后才开始运行。这会造成的问题：
  - 作业很大时，不能全部装入内存，导致大作业无法运行
  - 当大量作业要求运行时，由于内存无法容纳所有作业，因此只有少量作业能运行，导致多道程序并发度下降
- 驻留性：一旦作业被装入内存，就会一直驻留在内存中，直至作业运行结束。事实上，在一个时间段内，只需要访问作业的一小部分数据即可正常运行，这就导致了内存中会驻留大量的、暂时用不到的数据，浪费了宝贵的内存资源

#### 2、局部性原理

- 时间局部性
- 空间局部性
- 高速缓存技术的原理

#### 3、虚拟内存的定义和特征

- 虚拟内存管理要做的三件事情
  1. 程序装入时：基于局部性原理，在程序装入时，可以将程序中很快会用到的部分装入内存，暂时用不到的部分留在外存
  2. 程序运行时：
     - 当访问的信息不在内存时，由操作系统负责将所需信息从外存调入内存，然后继续执行程序；
     - 若内存空间不够，由操作系统负责将内存中暂时用不到的信息换出内存

- 在操作系统的管理下，在用户看来似乎有一个比实际内存大得多的内存，这就是虚拟内存
- 易混知识点：
  - 虚拟内存的最大容量是由计算机的地址结构（CPU寻址范围）确定的
  - 虚拟内存的实际容量 = min(内存和外存的容量之和，CPU寻址范围)
- 虚拟内存有以下三个主要特征
  - 多次性：无需在作业运行时一次性全部装入内存，而是允许被分成多次调入内存
  - 对换性：在作业运行时无需一直常驻内存，而是允许在作业运行过程中，将作业换入、换出
  - 虚拟性：从逻辑上扩充了内存的容量，使用户看到的内存容量，远大于实际的容量

#### 4、如何实现虚拟内存技术

- 虚拟内存技术，允许一个作业分多次调入内存。如果采用连续分配方式，会不方便实现。因此，虚拟内存的实现需要建立在离散分配的内存管理方式基础上。

​	<img src="https://ldt-typora.oss-cn-shenzhen.aliyuncs.com/img/image-20211219163514429.png" alt="image-20211219163514429" style="zoom:50%;" />



### 3.2.2 请求分页管理方式

#### 1、页表机制

<img src="https://ldt-typora.oss-cn-shenzhen.aliyuncs.com/img/image-20211219163827500.png" alt="image-20211219163827500" style="zoom:50%;" />

#### 2、缺页中断机构

- 在请求分页系统中，每当访问的页面不在内存时，便产生一个缺页中断，然后由操作系统的缺页中断处理程序处理中断。

  此时缺页的进程阻塞，放入阻塞队列，调页完成后再将其唤醒，放回就绪队列

- 缺页中断是因为当前执行的指令想要访问的目标页面未调入内存而产生的，因此属于内中断

- 一条指令在执行期间，可能产生多条缺页中断。（如 copy A to  B，即使逻辑地址A中的数据复制到逻辑地址B，而A、B属于不同的页面，则有可能产生两次中断）

  <img src="https://ldt-typora.oss-cn-shenzhen.aliyuncs.com/img/image-20211219164401530.png" alt="image-20211219164401530" style="zoom:50%;" />

#### 3、地址变换机构

- 只有“写指令”才需要修改“修改位”。并且，一般来说只需修改快表中的数据，只有要将快表项删除时才需要写回内存中的慢表。这样可以减少访存的次数

- 和普通的中断处理一样，缺页中断处理依然需要保护CPU现场

- 换出/换入页面都需要启动慢速的I/O操作，可见，如果换入/换出频繁，会有很大的开销

- 页面调入内存后，需要修改慢表，同时也需要将表项复制到快表中。

  <img src="https://ldt-typora.oss-cn-shenzhen.aliyuncs.com/img/image-20211219165142640.png" alt="image-20211219165142640" style="zoom:50%;" />

<img src="https://ldt-typora.oss-cn-shenzhen.aliyuncs.com/img/image-20211219165217977.png" alt="image-20211219165217977" style="zoom:50%;" />



### 3.2.3 页面置换算法

#### 1、最佳置换算法（OPT）

- 思路：每次选择淘汰的页面将是以后永不使用，或者在最长时间内不再被访问的页面，这样可以保证最低的缺页率

- 缺点：这是一种理想型的算法，操作系统根本无法实现

  <img src="https://ldt-typora.oss-cn-shenzhen.aliyuncs.com/img/image-20211219165700059.png" alt="image-20211219165700059" style="zoom:50%;" />

#### 2、先进先出置换算法（FIFO）

- 思路：每次选择淘汰的页面是最早进入内存的页面

  <img src="https://ldt-typora.oss-cn-shenzhen.aliyuncs.com/img/image-20211219170012761.png" alt="image-20211219170012761" style="zoom:50%;" />

#### 3、最近最久未使用置换算法（LRU）

- 思路：每次淘汰的页面是最近最久未使用的页面

  <img src="https://ldt-typora.oss-cn-shenzhen.aliyuncs.com/img/image-20211219170042547.png" alt="image-20211219170042547" style="zoom:50%;" />

#### 4、时钟置换算法（CLOCK）

- 实现方法：为每个页面设置一个访问位，再将内存中的页面都通过链接指针链接成一个循环队列。

  当某页被访问时，其访问位置为1。

  - 第一轮扫描：只需检查页的访问位。如果是0，就选择该页换出；如果是1，则将它置为0，暂不换出，继续检查下一个页面。

  - 第二轮扫描：如果第一轮扫描中所有页面都是1，则进行第二轮扫描。

    <img src="https://ldt-typora.oss-cn-shenzhen.aliyuncs.com/img/image-20211219170743487.png" alt="image-20211219170743487" style="zoom:50%;" />

#### 5、改进型的时钟置换算法

- 除了考虑一个页面最近有没有被使用之外，操作系统还考虑页面有没有被修改过。这样可以避免页面置换时发生I/O操作

  修改位=0，表示页面没有被修改过；

  修改为=1，表示页面被修改过

- 算法规则：

  <img src="https://ldt-typora.oss-cn-shenzhen.aliyuncs.com/img/image-20211219171116409.png" alt="image-20211219171116409" style="zoom:50%;" />

  

### 3.2.4 页面分配策略

我们前面学到的分页分配，所指的对象是面向整个内存空间的，现在的学的页面分配，所指的对象是进程，即为进程分配多少个页面。

#### 1、页面分配、置换策略

- 驻留集：指请求分页存储管理中给进程分配物理块的集合

  在采用虚拟存储技术的系统中，驻留集大小一般小于进程的总大小。

  如果驻留集太大，会导致多道程序的并发度下降，资源利用率降低。

- 固定分配：操作系统为每个进程分配一组固定数目的物理块，在进程运行期间不再改变。即驻留集不变
- 可变分配：先为每个进程分配一定数目的物理块，在进程运行期间，可根据情况适当的增加或减少。即，驻留集可变



- 局部置换：发生缺页时只能选进程自己的物理块进程置换
- 全局置换：可以将操作系统保留的空闲物理块分配给缺页进程，也可以将别的进程持有的物理块置换到外存，再分配给缺页进程

<img src="https://ldt-typora.oss-cn-shenzhen.aliyuncs.com/img/image-20211219172045711.png" alt="image-20211219172045711" style="zoom:50%;" />

- 可变分配全局置换：只要缺页就给分配新物理块
- 可变分配的局部置换：要根据发生缺页的频率来动态地增加或减少进程的物理块。

#### 2、何时调入页面

- 运行时前调入：预调页策略
- 运行时调入：请求调页策略

#### 3、从何处调入页面

- 系统拥有足够的对换区空间

- 系统缺少足够的对换区空间

- UNIX方式

  <img src="https://ldt-typora.oss-cn-shenzhen.aliyuncs.com/img/image-20211219183408855.png" alt="image-20211219183408855" style="zoom:50%;" />

#### 4、抖动（颠簸）现象

- 刚刚换出的页面马上又要换入内存，刚刚换入的页面马上又要换出内存，这种频繁的页面调度行为称为抖动，或颠簸。
- 产生抖动的主要原因是进程频繁访问的页面数目高于可用的物理块数



#### 5、工作集

<img src="https://ldt-typora.oss-cn-shenzhen.aliyuncs.com/img/image-20211219183931409.png" alt="image-20211219183931409" style="zoom:50%;" />